// En: src/services/metro.service.js
"use strict";

const util = require('util');
const exec = util.promisify(require('child_process').exec);
const path = require('path');
const geminiService = require('./gemini.service.js');

async function getMetroStatus(message) { // <-- Ahora recibe 'message'
    const scriptPath = path.resolve(__dirname, '..', '..', 'scripts', 'python', 'metro.py');

    try {
        await message.react('üöá');
        console.log(`(DEBUG) -> Ejecutando metro.py...`);
        const { stdout, stderr } = await exec(`python "${scriptPath}"`);

        if (stderr) {
            console.error(`(metro.py stderr): ${stderr}`);
            return `El script de Metro fall√≥: ${stderr}`;
        }
        
        const technicalReport = stdout;

        if (technicalReport.includes("Toda la red del metro est√° operativa") && !technicalReport.includes("problemas")) {
            await message.react('‚úÖ');
            // A√±adimos una comprobaci√≥n r√°pida para el estado de EFE tambi√©n
            if (technicalReport.includes("no operativo")) {
                 // Si EFE tiene problemas, mejor que lo analice la IA
            } else {
                 return "‚úÖ ¬°Buenas noticias! Toda la red de Metro y Trenes EFE se encuentra operativa.";
            }
        }
        
        console.log(`(DEBUG) -> Novedades detectadas. Pidiendo an√°lisis a Gemini...`);
        
        // --- PROMPT MEJORADO PARA INCLUIR TRENES ---
        const prompt = `
        Act√∫a como el Community Manager de la red de transporte de Santiago para un chat de WhatsApp.
        Te dar√© un reporte t√©cnico con el estado de los trenes de EFE y del Metro de Santiago.
        Tu misi√≥n es crear un √∫nico informe consolidado, amigable y claro.

        Instrucciones:
        1.  **Primero, busca la secci√≥n "Estado de Trenes (EFE)".** Resume el estado de "Tren Nos" y "Tren Rancagua". Usa un emoji de tren üöÜ.
        2.  **Segundo, analiza el estado del "Metro de Santiago".** Si todo est√° operativo, dilo en una frase. Si hay estaciones con problemas, l√≠stalas de forma clara. Usa un emoji de metro üöá.
        3.  **Finalmente, escribe una conclusi√≥n general** y una recomendaci√≥n como "¬°Planifica tu viaje!".

        Reporte T√©cnico:
        ---
        ${technicalReport}
        ---

        Ahora, genera tu informe consolidado para WhatsApp.
        `.trim();

        const analysis = await geminiService.generateText(prompt);
        await message.react('üí°');
        return analysis;

    } catch (error) {
        console.error("Error al ejecutar getMetroStatus:", error);
        await message.react('‚ùå');
        return "Ocurri√≥ un error mayor al ejecutar el an√°lisis de la red de transporte.";
    }
}

module.exports = {
    getMetroStatus
};