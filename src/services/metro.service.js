// En: src/services/metro.service.js
"use strict";

const pythonService = require('./python.service.js'); // <-- Importamos nuestro nuevo servicio
const geminiService = require('./gemini.service.js');
const { safeReact } = require('../utils/reaction.util');

async function getMetroStatus(message) { // <-- Ahora recibe 'message'
    try {
        await safeReact(message, 'üöá');
        
        // --- INICIO DEL CAMBIO ---
        // Ya no usamos 'exec', llamamos a nuestra funci√≥n centralizada
        const { stdout, stderr } = await pythonService.executePythonScript('metro.py');
        // --- FIN DEL CAMBIO ---

        if (stderr) {
            console.error(`(metro.py stderr): ${stderr}`);
            return `El script de Metro fall√≥: ${stderr}`;
        }
        
        const technicalReport = stdout;

        if (technicalReport.includes("Toda la red del metro est√° operativa") && !technicalReport.includes("no operativo")) {
            await safeReact(message, '‚úÖ');
            return "‚úÖ ¬°Buenas noticias! Toda la red de Metro y Trenes EFE se encuentra operativa.";
        }
        
        console.log(`(DEBUG) -> Novedades detectadas. Pidiendo an√°lisis a Gemini...`);
        
        const prompt = `
        Act√∫a como el Community Manager de Metro de Santiago...
        (Tu prompt de Gemini se mantiene igual)
        ---
        ${technicalReport}
        ---
        Ahora, genera el estado de la red para WhatsApp.
        `.trim();

        const analysis = await geminiService.generateText(prompt);
        await safeReact(message, 'üí°');
        return analysis;

    } catch (error) {
        console.error("Error al ejecutar getMetroStatus:", error);
        await safeReact(message, '‚ùå');
        return "Ocurri√≥ un error mayor al ejecutar el an√°lisis del Metro.";
    }
}

module.exports = {
    getMetroStatus
};