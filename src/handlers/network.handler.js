// En: src/handlers/network.handler.js
"use strict";

const util = require('util');
const exec = util.promisify(require('child_process').exec);
const path = require('path');
const geminiService = require('../services/gemini.service.js');

/**
 * Ejecuta el script de Python 'net_analyzer.py', toma su salida t√©cnica,
 * y la env√≠a a Gemini para que la analice y la presente de forma amigable.
 */
async function handleWhoisAnalysis(message) {
    const target = message.body.split(' ')[1];
    if (!target) {
        return message.reply("Por favor, indica un dominio o IP para analizar. Ejemplo: `!whois google.com`");
    }

    await message.react('üì°');
    
    // La ruta a tu script de Python
    const scriptPath = path.resolve(__dirname, '..', '..', 'scripts', 'python', 'net_analyzer.py');

    try {
        // 1. Ejecutamos el script de Python y obtenemos su salida t√©cnica (stdout)
        console.log(`(DEBUG) -> Ejecutando net_analyzer.py para: ${target}`);
        const { stdout, stderr } = await exec(`python "${scriptPath}" ${target}`);

        if (stderr && !stdout) { // Si hay un error y no hay salida normal
            console.error(`(net_analyzer.py stderr): ${stderr}`);
            return message.reply(`El script de an√°lisis fall√≥: ${stderr}`);
        }

        const technicalReport = stdout;

        // --- INICIO DE LA MEJORA ---
        // Si el reporte est√° vac√≠o o es muy corto (menos de 50 caracteres), 
        // significa que no se recolect√≥ casi nada. No molestamos a la IA.
        if (!technicalReport || technicalReport.trim().length < 50) {
            await message.react('ü§∑');
            return message.reply(`No se pudo recolectar suficiente informaci√≥n para analizar *"${target}"*. Es probable que el dominio est√© muy protegido o no exista.`);
        }
        // --- FIN DE LA MEJORA ---

        console.log(`(DEBUG) -> Reporte t√©cnico recibido, enviando a Gemini para an√°lisis...`);
        // 2. Creamos un prompt para que Gemini analice el reporte (ahora con la seguridad de que hay datos)
        const prompt = `
        Act√∫a como un analista de ciberseguridad que explica un reporte a un amigo.
        Te dar√© un reporte t√©cnico sobre un dominio y quiero que lo resumas en un lenguaje simple, con emojis y en formato para WhatsApp.
        Destaca los puntos m√°s importantes (buenos y malos) y da una conclusi√≥n general. Si hay errores como "timed out" o "conexi√≥n denegada", expl√≠calos de forma sencilla.

        Este es el reporte t√©cnico:
        ---
        ${technicalReport}
        ---

        Ahora, genera tu an√°lisis amigable.
        `.trim();

        // 3. Enviamos el reporte a Gemini para que lo "traduzca"
        const friendlyAnalysis = await geminiService.generateText(prompt);

        // 4. Enviamos el an√°lisis de la IA al usuario
        await message.react('üí°');
        return message.reply(friendlyAnalysis);

    } catch (error) {
        console.error("Error al ejecutar handleWhoisAnalysis:", error);
        await message.react('‚ùå');
        // Si el error contiene 'stderr', es probable que el script de Python haya fallado.
        const errorMessage = error.stderr || "Ocurri√≥ un error al ejecutar el an√°lisis. Revisa la consola.";
        return message.reply(errorMessage);
    }
}

module.exports = { handleWhoisAnalysis };